name: ðŸš€ Build Android APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release

jobs:
  build-android:
    name: ðŸ“± Build APK for Samsung S22 Ultra
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: â˜• Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ðŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ðŸ“¦ Install Dependencies
      run: |
        npm ci
        npm install -g @capacitor/cli
        
    - name: ðŸŽ¨ Generate Icons
      run: |
        mkdir -p icons
        # Create placeholder icons (in real scenario, you'd generate from SVG)
        echo "Creating placeholder icons for CI/CD..."
        
    - name: ðŸ”§ Initialize Capacitor
      run: |
        npx cap init "Gerador de Aulas CientÃ­ficas" "com.gugamilani940.geradoraulas" --web-dir="."
        
    - name: ðŸ“± Add Android Platform
      run: |
        npx cap add android
        
    - name: ðŸ”„ Sync Capacitor
      run: |
        npx cap sync android
        
    - name: ðŸ—ï¸ Build Android APK
      working-directory: ./android
      run: |
        chmod +x ./gradlew
        if [ "${{ github.event.inputs.build_type }}" == "release" ]; then
          ./gradlew assembleRelease
        else
          ./gradlew assembleDebug
        fi
        
    - name: ðŸ“‹ List APK Files
      run: |
        find android/app/build/outputs/apk -name "*.apk" -type f
        
    - name: ðŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gerador-aulas-apk-${{ github.run_number }}
        path: |
          android/app/build/outputs/apk/debug/*.apk
          android/app/build/outputs/apk/release/*.apk
        retention-days: 30
        
    - name: ðŸ“Š APK Info
      run: |
        APK_PATH=$(find android/app/build/outputs/apk -name "*.apk" -type f | head -1)
        if [ -f "$APK_PATH" ]; then
          echo "âœ… APK gerado com sucesso!"
          echo "ðŸ“ Caminho: $APK_PATH"
          echo "ðŸ“ Tamanho: $(du -h "$APK_PATH" | cut -f1)"
          echo "ðŸ·ï¸ Nome: $(basename "$APK_PATH")"
        else
          echo "âŒ APK nÃ£o encontrado!"
          exit 1
        fi

  test-apk:
    name: ðŸ§ª Test APK Quality
    needs: build-android
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ“± Download APK
      uses: actions/download-artifact@v4
      with:
        name: gerador-aulas-apk-${{ github.run_number }}
        path: ./apk
        
    - name: ðŸ” APK Analysis
      run: |
        APK_FILE=$(find ./apk -name "*.apk" -type f | head -1)
        if [ -f "$APK_FILE" ]; then
          echo "ðŸ” Analisando APK: $(basename "$APK_FILE")"
          
          # Verificar tamanho do APK
          SIZE=$(stat -f%z "$APK_FILE" 2>/dev/null || stat -c%s "$APK_FILE")
          SIZE_MB=$((SIZE / 1024 / 1024))
          
          echo "ðŸ“ Tamanho do APK: ${SIZE_MB}MB"
          
          if [ $SIZE_MB -gt 100 ]; then
            echo "âš ï¸ APK muito grande (>${SIZE_MB}MB). Considere otimizaÃ§Ãµes."
          else
            echo "âœ… Tamanho do APK adequado (${SIZE_MB}MB)"
          fi
          
          # Verificar estrutura bÃ¡sica
          if command -v aapt >/dev/null 2>&1; then
            echo "ðŸ“‹ InformaÃ§Ãµes do APK:"
            aapt dump badging "$APK_FILE" | head -10
          fi
        else
          echo "âŒ APK nÃ£o encontrado para anÃ¡lise!"
          exit 1
        fi

  create-release:
    name: ðŸŽ‰ Create GitHub Release
    needs: [build-android, test-apk]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ“± Download APK
      uses: actions/download-artifact@v4
      with:
        name: gerador-aulas-apk-${{ github.run_number }}
        path: ./release
        
    - name: ðŸ·ï¸ Generate Release Tag
      id: tag
      run: |
        TAG="v1.0.${{ github.run_number }}"
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Generated tag: $TAG"
        
    - name: ðŸ“ Generate Release Notes
      id: notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸ§¬ Gerador de Aulas CientÃ­ficas v1.0.${{ github.run_number }}
        
        ### ðŸ“± APK para Samsung S22 Ultra
        
        **ðŸ†• Novidades desta versÃ£o:**
        - âœ… Otimizado para Samsung S22 Ultra (6.8" Dynamic AMOLED 2X)
        - âœ… Interface responsiva para 3088x1440 pixels
        - âœ… Suporte completo ao One UI
        - âœ… Modo offline com Service Worker
        - âœ… IntegraÃ§Ã£o com OpenAI GPT-4
        
        **ðŸ“‹ Como instalar:**
        1. Baixe o arquivo `app-debug.apk`
        2. Ative "Fontes desconhecidas" no Android
        3. Instale o APK no seu Samsung S22 Ultra
        4. Configure sua chave da OpenAI no app
        
        **ðŸŽ¯ Compatibilidade:**
        - Samsung S22 Ultra (otimizado)
        - Android 8.0+ (API 26+)
        - Outros dispositivos Android modernos
        
        **ðŸ”§ Requisitos:**
        - Chave da OpenAI para geraÃ§Ã£o de aulas
        - ConexÃ£o com internet (primeira configuraÃ§Ã£o)
        - 100MB+ de espaÃ§o livre
        
        ---
        
        **ðŸ“Š EstatÃ­sticas do Build:**
        - Build #${{ github.run_number }}
        - Commit: ${{ github.sha }}
        - Data: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        EOF
        
    - name: ðŸŽ‰ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "Gerador de Aulas v1.0.${{ github.run_number }} - Samsung S22 Ultra"
        body_path: release_notes.md
        files: |
          release/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    name: ðŸ“¢ Notify Build Success
    needs: [build-android, test-apk]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ðŸŽ‰ Success Notification
      run: |
        echo "ðŸŽ‰ Build concluÃ­do com sucesso!"
        echo "ðŸ“± APK disponÃ­vel nos artifacts"
        echo "ðŸ”— Download: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # Criar summary para GitHub
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ## ðŸŽ‰ Build Android ConcluÃ­do!
        
        ### âœ… Status: Sucesso
        
        **ðŸ“± APK Gerado:**
        - âœ… CompilaÃ§Ã£o bem-sucedida
        - âœ… Testes de qualidade aprovados
        - âœ… Otimizado para Samsung S22 Ultra
        
        **ðŸ“¥ Download:**
        O APK estÃ¡ disponÃ­vel nos [artifacts desta execuÃ§Ã£o](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
        
        **ðŸ“‹ PrÃ³ximos passos:**
        1. Baixe o APK dos artifacts
        2. Transfira para seu Samsung S22 Ultra
        3. Instale e configure sua chave OpenAI
        4. Comece a gerar aulas cientÃ­ficas!
        
        ---
        
        **ðŸ”§ Build Info:**
        - Commit: `${{ github.sha }}`
        - Branch: `${{ github.ref_name }}`
        - Workflow: `${{ github.workflow }}`
        EOF
